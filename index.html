<!doctype html>
<html>

<head>
    <title>Monopoly Deal Online</title>
    <style>
    body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Helvetica';
        margin-bottom: 112px;
    }
    
    .chat {
        overflow: hidden;
        position: relative;
        bottom: 0;
        width: 100%;
        max-height: 200px;
        position: fixed;
    }
    
    form {
        background: #000;
        padding: 3px;
        width: 100%;
        bottom: 0;
    }
    
    form input {
        border: 0;
        padding: 10px;
        width: 80%;
        margin-right: .5%;
    }
    
    form button {
        background: rgb(130, 224, 255);
        border: none;
        padding: 10px;
    }
    
    #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
        height: 112px;
        overflow-y: auto;
    }
    
    #messages li {
        padding: 5px 10px;
    }
    
    #messages li:nth-child(odd) {
        background: #eee;
    }
    
    #messages li:nth-child(even) {
        background: #fff;
    }
    
    .card {
        width: 100px;
        background-color: gray;
        border-radius: 4px;
        height: 150px;
        margin: 5px;
        padding: 2px;
        text-align: center;
        flex-shrink: 0;
    }
    
    .card > .desc {
        font-size: .5em;
    }
    
    .myBoard,
    #myHand {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }
    
    .bank {
        flex-grow: 1;
        justify-content: center;
        text-align: center;
    }
    
    #myPlays {
        display: flex;
    }
    
    #myBank {
        justify-content: center;
        display: flex;
    }
    
    .inPlay {
        flex-grow: 2;
    }
    
    #myHand, #center {
        text-align: center;
        justify-content: center;
        display: flex;
    }
    
    .myHand .card {}
    
    .flex-container {
        display: flex;
    }
    
    .chat-input {
        flex-grow: 1;
    }

    .action{border: 1px solid orange;}
    .property{border: 1px solid black;}
    .money{border: 1px solid black;}

    </style>
    <link rel="css/stylesheet" href="style.css">
    <script src="js/frontend.js"></script>
</head>

<body>
    <a href="#" id="newgame">New Game</a>
    <hr> Deck
    <a href="#" id="drawCards">Draw Cards</a>
    <hr>
    <div id="debug"></div>
    <div id="center">center</div>
    <div class="stats">
        Turn:
        <div id="turn"></div>
        Action:
        <div id="action"></div>
    </div>
    <div class="myBoard">
        <div class="inPlay">
            <h2>In Play</h2>
            <div id="myPlays">
                <div class="card"></div>
                <div class="card"></div>
            </div>
        </div>
        <div class="bank">
            <h2>My Bank</h2>
            <div id="myBank">
                <div class="card"></div>
            </div>
        </div>
    </div>
    <h2>My Hand</h2>
    <div class="inHand">
        <div id="myHand"></div>
    </div>
    <hr>Players
    <div id="players">Players</div>
    <hr>
    <div class="chat">
        <ul id="messages"></ul>
        <form action="" class="flex-container">
            <input id="m" autocomplete="off" class="chat-input" />
            <button>Send</button>
        </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    var deck = 1;
    var board = {
        myHand: [],
        myBank: [],
        myPlays: [],
        players: [],
        myActions: 0,
        turn: ''
    };


    const messages = document.getElementById('messages');

    function updateBoard() {

        function actions(type, arrayPosition) {
            switch (type) {
                case 'money':
                    return '<a href="#" onClick="addToBank(' + i + ')" class="addToBank">Add to Bank</a>';
                    break;
                case 'action':
                    return '<a href="#" onClick="playCard(' + i + ')" class="playCard">Play Card</a>' +
                        '<a href="#" onClick="addToBank(' + i + ')" class="addToBank">Add to Bank</a>';
                    break;
                case 'property':
                    return '<a href="#" onClick="playCard(' + i + ')" class="playCard">Play Card</a>';;
                    break;
            }
        }
        $('#myHand').empty();
        for (var i = 0; i < board.myHand.length; i++) {

            $('#myHand').append('<div class="card ' + board.myHand[i].type + '">' +
                board.myHand[i].name +
                '<div class="desc">' + board.myHand[i].desc + '</div>' +
                '<div class="actions">' +
                actions(board.myHand[i].type, i) +
                '</div>' +
                '</div>');
        }

        $('#players').empty();
        for (var i = 0; i < board.players.length; i++) {
            $('#players').append($('<li>').text(board.players));
        }

        $('#myBank').empty();
        for (var i = 0; i < board.myBank.length; i++) {

            $('#myBank').append('<div class="card ' + board.myBank[i].type + '">' +
                board.myBank[i].name +
                '<div class="desc">' + board.myBank[i].desc + '</div>' +
                '<div class="actions">' +
                //actions(board.myHand[i].type, i) + 
                '</div>' +
                '</div>');
        }

        $('#myPlays').empty();
        for (var i = 0; i < board.myPlays.length; i++) {

            $('#myPlays').append('<div class="card ' + board.myPlays[i].type + '">' +
                board.myPlays[i].name +
                '<div class="desc">' + board.myPlays[i].desc + '</div>' +
                '<div class="actions">' +
                //actions(board.myHand[i].type, i) + 
                '</div>' +
                '</div>');
        }

        $('#action').html(board.myActions);
        $('#turn').html(board.turn);
    }

    function updateGame(game){

        console.log(game.center[0]);
     // $('#center').html(game.center[0].name);   
     $('#center').html('<div class="card ' + game.center[0].type + '">' +
                game.center[0].name +
                '<div class="desc">' + game.center[0].desc + '</div>' +
                '</div>');   
    }

    function endTurn() {
        socket.emit('chat message', socket.id + "'s turn is over");
    }

    function addToBank(arrayPosition) {
        var card = board.myHand.splice(arrayPosition, 1);
        console.log('attempt to move array position to bank');
        console.log(card[0])
        board.myBank.push(card[0]);
        board.myActions++;
        board.myActions > 3 && endTurn();
        updateBoard();
    }

    function playCard(arrayPosition) {

        var card = board.myHand.splice(arrayPosition, 1);
        console.log('attempt to play card');
        console.log(card[0])

        if (card[0].type == 'action') {
            // game.center.push(card[0])
            socket.emit('chat message', card[0].name + 'played');
        } else {
            board.myPlays.push(card[0]);
        }

        board.myActions++;
        socket.emit('play', card[0]);
        board.myActions > 3 && endTurn();
        updateBoard();
    }

    function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
    }


    var socket = io();
    $('form').submit(function() {
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
    });


    socket.on('chat message', function(msg) {
        $('#messages').append($('<li>').text(msg));

        shouldScroll = messages.scrollTop + messages.clientHeight === messages.scrollHeight;

        // console.log(shouldScroll + "" + (messages.scrollTop + messages.clientHeight) +" "+ messages.scrollHeight);

        //figure out if scroll position is the bottom
        /*
         * Get your messages, we'll just simulate it by appending a new one syncronously.
         */
        // After getting your messages.
        if (!shouldScroll) {
            scrollToBottom();
        }
    });

    // make new game
    $('#newgame').click(function() {
        // socket.emit('chat message', $('#m').val());
        socket.emit('shuffle', 'shuffle a new deck');
        // $('#m').val('');
        return false;
    });

    // make new game
    $('#drawCards').click(function() {
        socket.emit('chat message', "player " + socket.id + ' wants cards');

        board.myHand.length === 0 && drawCards(5);
        board.myHand.length > 0 && drawCards(2);

        return false;
    });

    function drawCards(qty) {
        socket.emit('drawCards', qty);
    }

    socket.on('New Deck', function(freshDeck) {
        console.log("you have a new deck");
        console.log(freshDeck);
        deck = freshDeck;

        // printAllCards(deck);
    });

    socket.on('players', function(players) {
        console.log("list of players" + players);
        board.players = players;

        updateBoard();

    });


    socket.on('receiveCards', function(cards) {

        //myHand.push(cards);
        //console.log(myHand);
        for (var i = 0; i < cards.length; i++) {
            board.myHand.push(cards[i]);
            console.log('pushed' + cards[i])
        }

        updateBoard();
    });


    socket.on('updateBoard', function(game) {
        // console.log(game);
        updateGame(game);
    });


    function findClientsSocket(roomId, namespace) {
        var res = []
            // the default namespace is "/"
            ,
            ns = io.of(namespace || "/");

        if (ns) {
            for (var id in ns.connected) {
                if (roomId) {
                    var index = ns.connected[id].rooms.indexOf(roomId);
                    if (index !== -1) {
                        res.push(ns.connected[id]);
                    }
                } else {
                    res.push(ns.connected[id]);
                }
            }
        }
        return res;
    }
    </script>
</body>

</html>
